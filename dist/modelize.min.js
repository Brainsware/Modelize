"use strict";var add_apis_to,api,api_key,api_user;("undefined"==typeof api_user||null===api_user)&&(api_user=""),("undefined"==typeof api_key||null===api_key)&&(api_key=""),api=new $.RestClient("/api/",{stripTrailingSlash:!0,methodOverride:!0,username:api_user,password:api_key}),add_apis_to=function(a,b){var c,d,e;e=[];for(d in a)c=a[d],api[b][d+"s"]?e.push(void 0):e.push(api[b].add(d+"s"));return e};var decryptData,encryptData,generateKey,generateSalt,getHash;generateKey=function(a,b){var c,d;return""===a?(console.error("Password for key generation empty!"),!1):(c=sjcl.codec.hex.fromBits,null==b&&(b=generateSalt()),d={salt:b,iter:5e3},d=sjcl.misc.cachedPbkdf2(a,d),sjcl.codec.hex.fromBits(d.key))},generateSalt=function(a){var b;return null==a&&(a=2),b=sjcl.random.randomWords(a),sjcl.codec.hex.fromBits(b)},encryptData=function(a,b,c){var d,e;return null==c&&(c=""),""===a?(console.error("Encryption key empty!"),!1):(d={mode:"gcm",iter:5e3,ts:64,ks:256,adata:c},e={},sjcl.encrypt(a,b,d,e))},decryptData=function(a,b){var c;return""===a?(console.error("Decryption key empty!"),!1):(c={},sjcl.decrypt(a,b,{},c))},getHash=function(a){var b;return null==a&&(console.debug("Hash value empty"),a=""),b=sjcl.hash.sha256.hash(a),sjcl.codec.hex.fromBits(b)};var Ham;Ham=function(){},Ham.merge=function(a,b){var c,d,e,f,g,h,i,j;for(j={},h=Object.keys(a),c=0,f=h.length;f>c;c++)e=h[c],j[e]=a[e];for(i=Object.keys(b),d=0,g=i.length;g>d;d++)e=i[d],null==a[e]&&(j[e]=b[e]);return j},"undefined"!=typeof module&&null!==module&&(module.exports=Ham);var create_fn,destroy_fn,get_fn,lazy_get_fn,lazy_single_get_fn,relationship_fields,single_get_fn,update_fn;relationship_fields=function(a,b,c){return null==c&&(c={}),[a+"_id",a+"s",a,window[b],c]},get_fn=function(a,b,c,d,e){return null==e&&(e={}),function(a){return function(c,f){var g;return null==c&&(c={}),g=function(c){var e,f,g,h;for(h=[],e=0,f=c.length;f>e;e++)g=c[e],h.push(d(g));return a[b](h)},"undefined"==typeof f.push&&("function"!=typeof f&&(console.error("Collection.find 2nd parameter needs to be either a function or a pushable object (Array, ObservableArray).\nGiven:"),console.error(f)),g=f),null!=e.belongs_to?a.api()[b].read(e.belongs_to,a.id,c).done(g):a.api()[b].read(a.id,c).done(g)}}(this)},single_get_fn=function(a,b,c,d,e){return null==e&&(e={}),function(b){return function(e,f){var g;return null==e&&(e={}),g=function(a){return b[c](d(a))},d.getOne(b[a](),g)}}(this)},lazy_get_fn=function(a,b,c,d,e){var f;return"undefined"==typeof f||null===f?(f=function(a){return function(c){var e,f,g,h;for(h=[],e=0,f=c.length;f>e;e++)g=c[e],h.push(d(g));return a[b](h)}}(this),this.api()[b].read(this.id).done(f)):void 0},lazy_single_get_fn=function(a,b,c,d,e){var f;return"function"!=typeof this[a]?(console.error("External key not an observable: "+a),!1):null==this[a]()?(console.error("Tried to access empty relation key: "+a),!1):"function"==typeof this[a]()?(console.error("Circular referene? Quitting."),!1):(("undefined"==typeof f||null===f)&&(f=function(a){return function(b){return a[c](d(b))}}(this)),d.getOne(this[a](),f))},create_fn=function(a,b,c,d,e){return function(a){return function(c,f,g){return null==c&&(c={}),null==g&&(g=!1),null==f&&(f=function(c){return a[b].push(d(c))}),null==a.id?void console.error("Empty ID. Save parent model first!"):(null!=d.encrypted_container&&(c=d.encrypt_container(c)),e.belongs_to.length>0?a.api()[b].create(e.belongs_to,a.id,c).done(f):a.api()[b].create(a.id,c).done(f))}}(this)},update_fn=function(a,b,c,d,e){return function(a){return function(c,f,g){return null==a.id?void console.error("Empty ID. Save parent model first!"):(null!=d.encrypted_container&&(f=d.encrypt_container(f)),null!=e.belongs_to?a.api()[b].update(e.belongs_to,a.id,c,f).done(g):a.api()[b].update(a.id,c,f).done(g),null!=a.after_update?a.after_update():void 0)}}(this)},destroy_fn=function(a,b,c,d,e){return function(a){return function(c,d){return null==d&&(d=function(c){return a[b].remove(element)}),null==a.id?void console.error("Empty ID. Save parent model first!"):null!=e.belongs_to?a.api()[b].destroy(e.belongs_to,a.id,c).done(d):a.api()[b].destroy(a.id,c).done(d)}}(this)};var DelayedSave,Editable,EncryptedDelayedSave;Editable=function(a,b,c){var d;return d="editing_"+b,Observable(a,b),"function"!=typeof a[b]?(console.error('Editable field "'+b+'" is not a valid Observable'),!1):(Observable(a,d,0),a[b].subscribe(function(a){return function(a){var d;return d=c(a,b)}}(this)),a)},DelayedSave=function(a,b){return function(c){return function(c,d,e){return null==e&&(e=250),null!=b.id?(null!=b["editing_"+d]&&b["editing_"+d](1),null==window.timeoutEditor&&(window.timeoutEditor={}),null==window.timeoutEditor[a.api+b.id]&&(window.timeoutEditor[a.api+b.id]={}),clearTimeout(window.timeoutEditor[a.api+b.id][d]),window.timeoutEditor[a.api+b.id][d]=setTimeout(function(){var a;return null!=b["editing_"+d]&&b["editing_"+d](2),a={},a[d]=c,b.update(a)},e)):void 0}}(this)},EncryptedDelayedSave=function(a,b){return function(c){return function(c,d,e){var f,g,h;if(null==e&&(e=250),"object"!=typeof b[a.encrypted_container]||null===b[a.encrypted_container]){b[a.encrypted_container]={},h=a.encrypted_editable;for(f in h)g=h[f],b[a.encrypted_container][g]=b[g]()}return b[a.encrypted_container][d]=c,null!=b.id?(b["editing_"+d](1),null==window.timeoutEditor&&(window.timeoutEditor={}),clearTimeout(window.timeoutEditor[a.api+b.id]),window.timeoutEditor[a.api+b.id]=setTimeout(function(){var a;return b.save_encrypted_container(),b["editing_"+d](2),a={},a[d]=c,b.update(a)},e)):void 0}}(this)};var Encryptable,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};Encryptable=function(a,b,c){var d,e,f;if(a.decrypt=function(b){return function(b){var c,d,e,f;if("string"==typeof b&&null!==b&&""!==b){c=decryptData(sessionStorage.getItem("appKey"),b),b=JSON.parse(c),e=[];for(d in b)f=b[d],e.push(a[d]=f);return e}}}(this),"string"==typeof b)a.decrypt(a[b]);else if("object"==typeof b)for(e=0,f=b.length;f>e;e++)d=b[e],a.decrypt(a[d]);return a.enc_update=function(d){return function(d,e){var f,g;for(f in d)g=d[f],indexOf.call(c,f)>=0&&(("object"!=typeof a[b]||null===a[b])&&(a[b]={}),a[b][f]=g);return a.save_encrypted_encrypted_container(),null!=e?e():void 0}}(this),a.save_encrypted_container=function(c){return function(){var c,d;return d=encryptData(sessionStorage.getItem("appKey"),JSON.stringify(a[b])),c={},c[b]=d,a.update(c)}}(this),a};var Computed,ComputedArray,LazyObservable,LazyObservableArray,Observable,ObservableArray,PureComputed,ko;"undefined"!=typeof require&&null!==require&&(ko=require("../../../knockout/build/output/knockout-latest.debug")),Observable=function(a,b,c){return void 0===c&&(c=a[b]),a[b]=ko.observable(c)},ObservableArray=function(a,b,c){return void 0===c&&(c=[]),a[b]=ko.observableArray(c),a[b].select=function(c){return ko.utils.arrayFilter(a[b].call(),c)},a[b].map=function(c){return ko.utils.arrayMap(a[b].call(),c)}},Computed=function(a,b,c){return a[b]=ko.computed(c,a)},PureComputed=function(a,b,c){return a[b]=ko.pureComputed(c,a)},ComputedArray=function(a,b,c){var d,e;return d="_actual_"+b,e="_"+b,ObservableArray(a,d),a[e]=function(b){return function(){return a[d](c()),a[d]()}}(this),a[b]=ko.computed(a[e])},LazyObservable=function(a,b,c,d,e,f){var g;return null==d&&(d=[]),null==e&&(e=null),null==f&&(f=!1),g=f?ko.observableArray(e):ko.observable(e),a[b]=ko.computed({read:function(){return a[b].loaded()===!1&&(console.debug("LazyLoading property",b),c.apply(a,d)),g()},write:function(c){return a[b].loaded(!0),g(c)},deferEvaluation:!0}),f===!0&&(a[b].remove=function(a){return g.remove(a)},a[b].push=function(a){return g.push(a)},a[b].splice=function(a,b,c){return g.splice(a,b,c)}),a[b].loaded=ko.observable(!1),a[b].refresh=function(){return a[b].loaded(!1)}},LazyObservableArray=function(a,b,c,d,e){return null==d&&(d=[]),null==e&&(e=null),LazyObservable(a,b,c,d,e,!0)},"undefined"!=typeof module&&null!==module&&(module.exports={Observable:Observable,ObservableArray:ObservableArray,Computed:Computed,ComputedArray:ComputedArray,LazyObservable:LazyObservable});var Computed,Ham,Observable,Observables,Paginated;"undefined"!=typeof require&&null!==require&&(Ham=require("../ham"),Observables=require("../lib/observable"),Observable=Observables.Observable,Computed=Observables.Computed),Paginated=function(a,b){if(null==a||null==b)throw new Error("Error: no object or options given");if("object"!=typeof a)throw new Error("Error: first parameter is not an object");if("function"==typeof b&&(b={method:b}),"object"!=typeof b)throw new Error("Invalid type for second parameter ("+typeof b+"), expected function or object");if(b=Ham.merge(b,{per_page:20,page:0}),b.page>0&&b.page--,!("number"==typeof b.per_page&&b.per_page>0))throw new Error("Invalid per_page value given");if(null==b.method)throw new Error("No reload method given");return Paginated.add_paginated_methods(a,b)},Paginated.add_paginated_methods=function(a,b){return Observable(a,"__collection",b.collection),Observable(a,"__reload",b.method),Observable(a,"__page",b.page),Observable(a,"per_page",b.per_page),Computed(a,"page",function(b){return function(){return a.__page()+1}}(this)),Computed(a,"count",function(b){return function(){return null!=a.__collection()?a.__collection().count:0}}(this)),Computed(a,"pages",function(b){return function(){var b;return b=parseInt(parseFloat(a.count())/parseFloat(a.__page())),parseFloat(a.count())%a.__page()>0&&b++,b}}(this)),a.first_page=function(b){return function(){return a.__page(0),a.__collection(a.__reload())}}(this),a.last_page=function(b){return function(){return a.__page(a.count()-1),a.__collection(a.__reload())}}(this),a.previous_page=function(b){return function(){return a.page()>0?(a.__page(a.page()-1),a.__collection(a.__reload())):void 0}}(this),a.next_page=function(b){return function(){return a.page()+1<a.pages()?(a.__page(a.page()+1),a.__collection(a.__reload())):void 0}}(this)},"undefined"!=typeof module&&null!==module&&(module.exports=Paginated);var Selectable;Selectable=function(a){return a.selected=ko.observable(!1),a.select=function(b){return function(b,c){return a.selected(!a.selected())}}(this),a};var Sortable;Sortable=function(a){return a.move=function(b){return function(b,c){return a.update({sort:b},c)}}(this),a.move_ui=function(a){return function(a){var b,c;return b=a.item,c=a.targetIndex,b.update({sort:c})}}(this),a};var Modelize,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};Modelize=function(a){var b,c;return null==api[a.api]&&api.add(a.api),b=api[a.api],null!=a.has_one&&add_apis_to(a.has_one,a.api),null!=a.has_many&&add_apis_to(a.has_many,a.api),c=function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;if(null==c&&(c={}),c.api=function(){return b},null!=a.encrypted_container&&Encryptable(c,a.encrypted_container,a.encrypted_editable),null!=a.sortable&&a.sortable===!0&&Sortable(c),null!=a.selectable&&a.selectable===!0&&Selectable(c),null!=a.belongs_to?(null==a.has_one&&(a.has_one=[]),a.has_one=Ham.merge(a.belongs_to,a.has_one)):a.belongs_to=[],null!=a.has_one){l=a.has_one;for(k in l)d=l[k],Ham.merge(d,{model:k.capitalize()}),v=relationship_fields(k,d.model,a),e=window[d.model],"function"!=typeof c[k+"_id"]&&indexOf.call(a.belongs_to,k)<0&&(null==a.editable&&(a.editable=[]),a.editable.push(k+"_id")),null!=c[k]?Observable(c,k,new e(c[k])):Observable(c,k,new e),c[k+"_get"]=single_get_fn.apply(c,v)}if(null!=a.has_many){m=a.has_many;for(k in m){if(d=m[k],Ham.merge(d,{model:k.capitalize()}),v=relationship_fields(k,d.model,a),null!=c[k+"s"]){for(e=window[d.model],i=[],n=c[k+"s"],f=0,j=n.length;j>f;f++)h=n[f],i.push(new e(h));ObservableArray(c,k+"s",i)}else ObservableArray(c,k+"s",[]);c[k+"_get"]=get_fn.apply(c,v),c[k+"_add"]=create_fn.apply(c,v),c[k+"_update"]=update_fn.apply(c,v),c[k+"_destroy"]=destroy_fn.apply(c,v)}}if(null!=a.observable){o=a.observable;for(g in o)k=o[g],Observable(c,k)}if(null!=a.editable){p=a.editable;for(g in p)k=p[g],Editable(c,k,DelayedSave.apply(c,[a,c]))}if(null!=a.encrypted_editable){q=a.encrypted_editable;for(g in q)k=q[g],Editable(c,k,EncryptedDelayedSave.apply(c,[a,c]))}if(null!=a.computed){r=a.computed;for(k in r)e=r[k],Computed(c,k,e)}if(null!=a.purecomputed){s=a.purecomputed;for(k in s)e=s[k],PureComputed(c,k,e)}if(null!=a.computed_array){t=a.computed_array;for(k in t)e=t[k],ComputedArray(c,k,e)}if(null!=a.functions){u=a.functions;for(k in u)e=u[k],c[k]=e}return c.update=function(a){return function(a,b){return null==c.id?(console.error("Trying to update nonexisting model object"),!1):c.api().update(c.id,a).done(b)}}(this),c.destroy=function(a){return function(a){return null==c.id?(console.error("Trying to delete nonexisting model object"),!1):c.api().destroy(c.id).done(a)}}(this),c.create=function(d){return function(d){return b.create(c["export"]()).done(function(b){return c.id=b.id,null!=a.encrypted_container&&c.enc_update(b),d()})}}(this),c["export"]=function(b){return function(){var b,e,f,h;if(d={},null!=a.editable){e=a.editable;for(g in e)k=e[g],d[k]=c[k]()}if(null!=a.encrypted_editable){f=a.encrypted_editable;for(g in f)k=f[g],d[k]=c[k]()}if(null!=a.belongs_to){h=a.belongs_to;for(k in h)b=h[k],d[k+"_id"]=c[k+"_id"]}return d}}(this),c},c.get=function(a,d){var e;return null==a&&(a={}),e=function(a){var b,e,f,g;for(g=[],b=0,e=a.length;e>b;b++)f=a[b],g.push(d.push(c(f)));return g},"undefined"==typeof d.push&&("function"!=typeof d&&(console.log("model.get 2nd parameter needs to be either a function or a pushable object (Array, ObservableArray).\nGiven:"),console.log(d)),e=d),"object"!=typeof a?void console.error(a,typeof a):null!=a&&null!=a.id?b.read(a.id,a).done(e):b.read(a).done(e)},c.getOne=function(a,b){return c.get({id:a},b)},c.create=function(a,d){var e;return null==a&&(a={}),e=function(a){return d.push(c(a))},"undefined"==typeof d.push&&("function"!=typeof d&&(console.log("model.create 2nd parameter needs to be either a function or a pushable object (Array, ObservableArray).\nGiven:"),console.log(d)),e=function(a){return function(a){var b;return b=c(JSON.parse(JSON.stringify(a))),null!=b.after_create&&b.after_create(),d(a)}}(this)),a.length>0||"object"==typeof a?(null!=c.encrypted_container&&(a=c.encrypt_container(a)),b.create(a).done(e)):b.create().done(e)},null!=a.encrypted_container&&(c.encrypted_container=a.encrypted_container),null!=a.encrypted_editable&&(c.encrypted_editable=a.encrypted_editable),c.encrypt_container=function(a,b){var d,e,f;a[c.encrypted_container]={};for(e in a)f=a[e],indexOf.call(c.encrypted_editable,e)>=0&&(a[c.encrypted_container][e]=f);return d=encryptData(sessionStorage.getItem("appKey"),JSON.stringify(a[c.encrypted_container])),a[c.encrypted_container]=d,a},c};
//# sourceMappingURL=modelize.min.js.map